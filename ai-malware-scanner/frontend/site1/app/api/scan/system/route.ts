import { type NextRequest, NextResponse } from "next/server"
import clientPromise from "@/lib/mongodb"
import { generateMockScanResult } from "@/lib/utils"

export async function POST(request: NextRequest) {
  try {
    const { scanType, customPath } = await request.json()

    // Generate scan ID
    const scanId = new Date().getTime().toString()

    // Start background scan simulation
    setTimeout(async () => {
      try {
        const scanResult = generateMockScanResult(
          scanType === "custom" ? customPath : `System ${scanType} Scan`,
          "system",
        )

        // Save completed scan to MongoDB
        const client = await clientPromise
        const db = client.db("cybersecurity_scanner")
        const collection = db.collection("scan_results")

        await collection.insertOne({
          ...scanResult,
          scanId,
          status: "completed",
        })
      } catch (error) {
        console.error("Background scan error:", error)
      }
    }, 10000) // 10 second scan simulation

    return NextResponse.json({
      success: true,
      scanId,
      message: "System scan started",
    })
  } catch (error) {
    console.error("System scan error:", error)
    return NextResponse.json({ error: "Scan failed to start" }, { status: 500 })
  }
}
